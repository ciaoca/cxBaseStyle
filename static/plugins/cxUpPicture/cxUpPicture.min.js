/*!
 * cxUpPicture 1.1
 * http://code.ciaoca.com/
 * E-mail: ciaoca@gmail.com
 * Released under the MIT license
 * Date: 2021-06-27
 * 
 * @param {object} settings 参数设置
 *   maxLength {int} 最多上传数量
 *   maxWidth {int} 最大宽度
 *   maxHeight {int} 最大高度
 *   haveClass {string} 包含文件时的 className
 */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery||window.Zepto||window.$)}(function(a){a.cxUpPicture=function(){var b={dom:{},isElement:function(a){return a&&("function"==typeof HTMLElement||"object"==typeof HTMLElement)&&a instanceof HTMLElement?!0:a&&a.nodeType&&1===a.nodeType?!0:!1},isJquery:function(a){return a&&a.length&&("function"==typeof jQuery||"object"==typeof jQuery)&&a instanceof jQuery?!0:!1},isZepto:function(a){return a&&a.length&&("function"==typeof Zepto||"object"==typeof Zepto)&&Zepto.zepto.isZ(a)?!0:!1}};b.init=function(){var c,d,e,b=this;for(d=0,e=arguments.length;e>d;d++)b.isJquery(arguments[d])||b.isZepto(arguments[d])?b.dom.box=arguments[d]:b.isElement(arguments[d])?b.dom.box=a(arguments[d]):"object"==typeof arguments[d]&&(c=arguments[d]);b.dom.box.length&&b.dom.box.find("li").length&&(b.settings=a.extend({},a.cxUpPicture.defaults,c,{maxLength:b.dom.box.data("maxLength"),maxWidth:b.dom.box.data("maxWidth"),maxHeight:b.dom.box.data("maxHeight"),haveClass:b.dom.box.data("haveClass")}),b.dom.fileCanvas=document.createElement("canvas"),b.tmpHtml=b.dom.box.find("li").last()[0].outerHTML,b.dom.box.on("click","a",function(){var c=this,d=c.rel,e=a(c).closest("li");"remove"===d&&(event.preventDefault(),"string"==typeof c.dataset.urlDelete&&c.dataset.urlDelete.length?(e.css("display","none"),a.ajax({url:c.dataset.urlDelete,type:"GET",dataType:"json"}).done(function(){e.remove()}).fail(function(){e.css("display","")})):e.remove(),b.addFile())}),b.dom.box.on("change","input",function(){var d,e,f,c=this;"file"===c.type&&(d=c.files[0],e=a(c).closest("label"),f=e.closest("li"),EXIF.getData(d,function(){var a=EXIF.getTag(c,"Orientation"),g=0;switch(a){case 3:g=180;break;case 6:g=90;break;case 8:g=270;break;default:g=0}_fileImg=new MegaPixImage(d),_fileImg.render(b.dom.fileCanvas,{maxWidth:b.settings.maxWidth,maxHeight:b.settings.maxHeight,orientation:a}),setTimeout(function(){var a=b.dom.fileCanvas.toDataURL();f.addClass(b.settings.haveClass),e.css("backgroundImage","url("+a+")"),f.find("input[type=hidden]").length&&f.find("input[type=hidden]").val(a),b.addFile()},200)}))}))},b.addFile=function(){var a=this;(!a.dom.box.find("li").length||a.dom.box.find("li").length<a.settings.maxLength&&a.dom.box.find("li").last().hasClass(a.settings.haveClass))&&a.dom.box.append(a.tmpHtml)},b.init.apply(b,arguments)},a.cxUpPicture.defaults={maxLength:9,maxWidth:200,maxHeight:200,haveClass:"have"},a.fn.cxUpPicture=function(b){return this.each(function(){a.cxUpPicture(this,b)}),this}});